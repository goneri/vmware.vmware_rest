- name: Build a list of all the clusters
  vcenter_cluster_info:
  register: all_the_clusters
- name: Build a list of all the datastores
  vcenter_datastore_info:
  register: my_datastore_value
- name: Build a list of all the folders
  vcenter_folder_info:
  register: my_folder_value
- name: Retrieve details about the first cluster
  vcenter_cluster_info:
    cluster: "{{ all_the_clusters.value[0].cluster }}"
  register: my_cluster_info

- set_fact:
    rw_datastore: '{{ my_datastore_value.value|selectattr("name", "equalto", "rw_datastore")|first }}'
    my_virtual_machine_folder: '{{ my_folder_value.value|selectattr("type", "equalto", "VIRTUAL_MACHINE")|first }}'

- name: Create a VM
  vcenter_vm:
    placement:
      cluster: "{{ all_the_clusters.value[0].cluster }}"
      datastore: "{{ rw_datastore.datastore }}"
      folder: "{{ my_virtual_machine_folder.folder }}"
      resource_pool: "{{ my_cluster_info.value.resource_pool }}"
    name: test_vm1
    guest_OS: DEBIAN_8_64
    hardware_version: VMX_11
    memory:
      hot_add_enabled: true
      size_MiB: 1024
    state: create
  register: _create_vm
- debug: var=_create_vm

- register: _should_be_empty
  name: Search with an invalid filter
  vcenter_vm_info:
    filter_names: test_vm1_does_not_exists
- assert:
    that:
      - _should_be_empty.value == []

- register: test_vm1
  vcenter_vm_info:
    filter_names: "test_vm1"

- debug: var=test_vm1

- name: Collect information about a specific VM
  vcenter_vm_info:
    vm: '{{ test_vm1.value[0].vm }}'

- name: List the SATA adapter of a given VM
  vcenter_vm_hardware_adapter_sata_info:
    vm: '{{ test_vm1.value[0].vm }}'
