- appliance_networking_interfaces_info:

- vcenter_cluster_info:

# - import_tasks: purge_vms.yaml
# - import_tasks: cleanup.yaml
- import_tasks: prepare.yaml

- vcenter_cluster_info:
  register: all_the_clusters
- vcenter_datastore_info:
  register: my_datastore_value
- vcenter_folder_info:
  register: my_folder_value
- vcenter_cluster_info:
    cluster: "{{ all_the_clusters.value[0].cluster }}"
  register: my_cluster_info

- set_fact:
    rw_datastore: '{{ my_datastore_value.value|selectattr("name", "equalto", "rw_datastore")|first }}'
    my_virtual_machine_folder: '{{ my_folder_value.value|selectattr("type", "equalto", "VIRTUAL_MACHINE")|first }}'

- vcenter_vm:
    placement:
      cluster: "{{ all_the_clusters.value[0].cluster }}"
      datastore: "{{ rw_datastore.datastore }}"
      folder: "{{ my_virtual_machine_folder.folder }}"
      resource_pool: "{{ my_cluster_info.value.resource_pool }}"
    name: test_vm1
    guest_OS: DEBIAN_8_64
    hardware_version: VMX_11
    memory:
      hot_add_enabled: true
      size_MiB: 1024
    state: create

# TODO, filer are not functional yet
- register: test_vm1
  vcenter_vm_info:
    filter.names:
    - test_vm1

- vcenter_vm_info:
    vm: '{{ test_vm1.value[0].vm }}'

- vcenter_vm_hardware_adapter_sata_info:
    vm: '{{ test_vm1.value[0].vm }}'

# ETHERNET
- vcenter_vm_hardware_ethernet:
    state: create
    vm: '{{ test_vm1.value[0].vm }}'
    pci_slot_number: 4
    backing:
      distributed_switch_uuid: 5026ec1956b571d8-cad88207f7d9ca46
      type: DISTRIBUTED_PORTGROUP

- vcenter_vm_hardware_ethernet:
    state: create
    vm: '{{ test_vm1.value[0].vm }}'
    pci_slot_number: 4

# SATA CONTROLLER
- vcenter_vm_hardware_adapter_sata:
    state: create
    vm: '{{ test_vm1.value[0].vm }}'
    pci_slot_number: 1

- vcenter_vm_hardware_adapter_sata:
    state: create
    vm: '{{ test_vm1.value[0].vm }}'
    pci_slot_number: 1

# CDROM
- vcenter_vm_hardware_cdrom:
    vm: '{{ test_vm1.value[0].vm }}'
    type: SATA
    sata:
      bus: 0
      unit: 2
    start_connected: true
    backing:
      iso_file: '[ro_datastore] fedora.iso'
      type: ISO_FILE
    state: create

- vcenter_vm_hardware_cdrom:
    vm: '{{ test_vm1.value[0].vm }}'
    type: SATA
    sata:
      bus: 0
      unit: 2
    start_connected: true
    backing:
      iso_file: '[ro_datastore] fedora.iso'
      type: ISO_FILE
    state: create

- vcenter_vm_hardware_boot_info:
    vm: '{{ test_vm1.value[0].vm }}'

- vcenter_vm_hardware_boot:
    vm: '{{ test_vm1.value[0].vm }}'
    efi_legacy_boot: True
    type: EFI
    state: update

- vcenter_vm_power:
    state: start
    vm: '{{ test_vm1.value[0].vm }}'

- vcenter_vm_info:
    vm: '{{ test_vm1.value[0].vm }}'

- import_tasks: wait_for_test_vm1.yaml